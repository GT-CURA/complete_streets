# Manual Street Buffer Width Annotation Tool

## üìç Objective
Our automated pipeline estimates street buffer width from street view imagery using semantic segmentation and geometric reasoning; however, it occasionally fails. Because segmentation models are not perfect and cannot handle every edge case automatically, this tool offers a **Jupyter-based manual annotation interface** that enables users to directly mark the sidewalk bottom edge and road top edge, explore alternative imagery, and compute an estimated street buffer width.

### Input:
- A GeoJSON file of road segment points (Same as used in the automated tool)
- CSV files of street buffer width estimates (Stored in the `outputs_automation` directory produced by the automated tool)

### Process:
1. Identify cases from the automated tool that have invalid width estimates (NaN or out-of-range values).  
2. Load the original pre-downloaded street view images for these invalid cases.  
3. Move the camera location or adjust zoom level to obtain clearer street buffer visibility.  
4. Manually mark the sidewalk bottom edge and road top edge (curb line) for both pitch 0¬∞ and pitch ‚àí10¬∞ images.  
5. The tool automatically computes the estimated street buffer width and writes results to a CSV file.

### Output:
- A CSV file for each input case containing the estimated `width`. 
- All newly downloaded images (for zoomed or moved viewpoints) are saved locally under the `/outputs` directory.

<br>
<br>

## üì¶ Features:
- **Jupyter Lab Scripts (.ipynb)** 
  1. **0_filter.ipynb**: Identifies invalid cases where the automated tool produced NaN or unrealistic widths (e.g., <1.0 m or >5.0 m). 
  2. **1_manual_annotation.ipynb**:  Launches the interactive Jupyter-based annotation interface for manual correction.
     
- **`invalid_cases.csv`** *example output*  
  Contains all road segment points where the automated street buffer width estimation failed or produced implausible results. These cases require manual annotation using the interactive tool.

- **`valid_cases.csv`** *example output*  
  Includes all records with valid street buffer width estimates within the acceptable range or confirmed absence of buffer.


- **`/outputs`** *example output*  
  Stores newly downloaded imagery and the final annotation CSV file (`manual_collection_invalid.csv`).

<br>
<br>

## üöó Quick Guide

### 1. Create and Activate a Conda Environment
  ```bash
  conda create -n streetbuffer_manual python=3.10 -y
  conda activate streetbuffer_manual
  ```

### 2. Install Dependencies
  ```bash
  conda install -c conda-forge numpy pandas geopandas scipy requests pillow ipywidgets ipyevents jupyterlab -y
  pip install ipywidgets jupyterlab_widgets
  ```

### 3. Register the Jupyter Kernel
  ```bash
  python -m ipykernel install --user --name streetbuffer_manual --display-name "streetbuffer_manual"
  ```

### 4. Launch JupyterLab
Open JupyterLab using the kernel `streetbuffer_manual`
  ```bash
  jupyter lab
  ```

### 5. Run `0_filter.ipynb`
Open and execute the notebook `0_filter.ipynb`. This script scans all output CSV files generated by the automated street buffer width estimation tool and classifies them into two categories:
- Valid cases ‚Äì street buffer widths that fall within the acceptable range or are confirmed to have no buffer
- Invalid cases ‚Äì street buffer widths that are either missing (NaN) or unrealistic (too small or too large)

These invalid cases will later be reviewed and corrected in the manual annotation interface.

### 6. Run `1_manual_annotation.ipynb`
Open and execute the notebook `0_filter.ipynb`. In the first cell, update the paths and API key so they match your environment. After editing these values, run the next cell. It will start the manual annotation interface, which looks like this:

<p align="left"> <img src="fig/tool_layout.png" width="940" alt="Layout of the interface tool"> </p>

To estimate the street buffer width, click the sidewalk bottom edge and road top edge in both pitch views (0¬∞ and ‚àí10¬∞). After placing all four points, the tool automatically computes and displays the estimated width in meters.

*Note* Similar to the automated algorithm, please mark the points at approximately the same horizontal position across the two pitch angles (0¬∞ and ‚àí10¬∞).

<br>

For more details on the functions used in this interactive tool, refer to the *Sidewalk Manual Annotation Tool* ([https://github.com/GT-CURA/complete_streets/tree/main/step2_elements/sidewalk/manual_collection]), which is built on the same framework.

<br>

### References
If you use this model, please cite the following paper: 

```bibtex
@article{your_article,
  title   = {A novel approach for estimating sidewalk width from street view images and computer vision},
  author  = {Lieu, S. J., & Guhathakurta, S.},
  journal = {Environment and Planning B: Urban Analytics and City Science},
  year    = {2025}
}
